---
import Layout from '../../layouts/Layout.astro';
import FloatingHomeNav from '../../components/FloatingHomeNav.astro';
import Footer from '../../components/Footer.astro';
import { useTranslations, languages, type Languages } from '../../i18n/utils';
import storiesRaw from '../../data/stories.json';

export function getStaticPaths() {
  return Object.keys(languages).map(lang => ({
    params: { lang }
  }));
}

const { lang } = Astro.params;
const typedLang = lang as Languages;
const t = useTranslations(typedLang);

// ── Resolve stories: auto-prefix image paths, look up city coordinates ──
// Hardcoded coords for city names — instant, offline, never breaks
const CITY_COORDS: Record<string, { lat: number; lng: number }> = {
  'dubrovnik, croatia':    { lat: 42.6507, lng: 18.0944 },
  'pécs, hungary':         { lat: 46.0727, lng: 18.2323 },
  'budapest, hungary':     { lat: 47.4979, lng: 19.0402 },
  'bük, hungary':          { lat: 47.3839, lng: 16.7422 },
  'lake balaton, hungary': { lat: 46.8300, lng: 17.7100 },
  'milan, italy':          { lat: 45.4642, lng: 9.1900 },
  'florence, italy':       { lat: 43.7696, lng: 11.2558 },
  'rome, italy':           { lat: 41.9028, lng: 12.4964 },
};

// Sort newest first
const sorted = [...storiesRaw].sort((a, b) => b.date.localeCompare(a.date));

type ResolvedStory = {
  photo: string;
  date: string;
  lat: number;
  lng: number;
  label: string;
  description: string;
};
const stories: ResolvedStory[] = [];

for (const s of sorted) {
  const photo = `/assets/images/stories/${s.image}`;
  const description = (s as any).description || '';
  let lat = 0, lng = 0, label = '';

  if (Array.isArray(s.location)) {
    // User provided [lat, lng] directly
    lat = s.location[0];
    lng = s.location[1];
    label = (s as any).label || `${lat.toFixed(2)}, ${lng.toFixed(2)}`;
  } else {
    // City name string → look up from table
    label = s.location;
    const key = s.location.toLowerCase();
    const coords = CITY_COORDS[key];
    if (coords) {
      lat = coords.lat;
      lng = coords.lng;
    } else {
      console.warn(`[stories] Unknown location "${s.location}" — add it to CITY_COORDS in stories.astro`);
    }
  }

  stories.push({ photo, date: s.date, lat, lng, label, description });
}
---

<Layout 
  title={t('stories.title')}
  description={t('stories.description')}
  keywords="Balla Botond, stories, travel, photos, map, places, moments"
>
  <FloatingHomeNav />

  <!-- Map container - full screen -->
  <div id="stories-map" class="fixed inset-0 z-0"></div>

  <!-- Header overlay -->
  <div class="fixed top-0 left-0 right-0 z-20 pointer-events-none">
    <div class="pt-6 pb-4 px-6 text-center" style="background: linear-gradient(to bottom, rgba(17,24,39,0.9) 0%, rgba(17,24,39,0.6) 60%, transparent 100%);">
      <p class="font-montserrat text-xs uppercase tracking-[0.3em] text-luxury-gold mb-1">{t('stories.tagline')}</p>
      <h1 class="font-playfair text-2xl md:text-3xl font-medium text-white">{t('stories.subtitle')}</h1>
      <p class="font-montserrat text-xs text-luxury-gray mt-2 opacity-70">{t('stories.zoomIn')}</p>
    </div>
  </div>

  <!-- Photo lightbox overlay -->
  <div id="lightbox" class="fixed inset-0 z-[200] hidden items-center justify-center" style="background: rgba(0,0,0,0.92); backdrop-filter: blur(20px);">
    <button id="lightbox-close" class="absolute top-6 right-6 text-white/70 hover:text-white transition-colors z-10 cursor-pointer" aria-label={t('stories.close')}>
      <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
    </button>
    <div class="flex flex-col items-center max-w-4xl mx-auto px-6">
      <img id="lightbox-img" src="" alt="" class="max-h-[75vh] max-w-full object-contain rounded-lg shadow-2xl" />
      <div class="mt-4 text-center">
        <p id="lightbox-location" class="font-playfair text-xl text-white"></p>
        <p id="lightbox-date" class="font-montserrat text-sm text-luxury-gold mt-1"></p>
        <p id="lightbox-description" class="font-montserrat text-sm text-white/70 mt-2 max-w-lg"></p>
      </div>
    </div>
  </div>

  <!-- Hidden data for JS -->
  <div id="stories-data" style="display:none" data-stories={JSON.stringify(stories)}></div>

  <!-- MapLibre CSS -->
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" />
  <!-- MapLibre GL JS -->
  <script is:inline src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>

  <!-- Map init — must be is:inline to access maplibregl global -->
  <script is:inline>
    function initStoriesMap() {
      if (typeof maplibregl === 'undefined') {
        setTimeout(initStoriesMap, 100);
        return;
      }

      var mapContainer = document.getElementById('stories-map');
      if (!mapContainer) return;

      // Prevent double init
      if (mapContainer.children.length > 0) return;

      var dataEl = document.getElementById('stories-data');
      if (!dataEl) return;

      var stories = JSON.parse(dataEl.getAttribute('data-stories') || '[]');
      // Filter out entries with invalid coordinates
      stories = stories.filter(function(s) { return s.lat !== 0 || s.lng !== 0; });
      if (!stories.length) return;

      // Calculate center from all stories
      var avgLat = stories.reduce(function(s, p) { return s + p.lat; }, 0) / stories.length;
      var avgLng = stories.reduce(function(s, p) { return s + p.lng; }, 0) / stories.length;

      var map = new maplibregl.Map({
        container: 'stories-map',
        style: {
          version: 8,
          name: 'Dark',
          sources: {
            'carto-dark': {
              type: 'raster',
              tiles: [
                'https://a.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}@2x.png',
                'https://b.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}@2x.png',
                'https://c.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}@2x.png'
              ],
              tileSize: 256,
              attribution: '&copy; <a href="https://carto.com/">CARTO</a> &copy; <a href="https://www.openstreetmap.org/copyright">OSM</a>'
            }
          },
          layers: [
            {
              id: 'carto-dark-layer',
              type: 'raster',
              source: 'carto-dark',
              minzoom: 0,
              maxzoom: 20
            }
          ]
        },
        center: [avgLng, avgLat],
        zoom: 5,
        minZoom: 2,
        maxZoom: 16
      });

      map.on('load', function() {
        // Group stories by coordinates (same location = same key)
        var groups = {};
        stories.forEach(function(story) {
          var key = story.lat.toFixed(3) + ',' + story.lng.toFixed(3);
          if (!groups[key]) groups[key] = [];
          groups[key].push(story);
        });

        // Track secondary markers for smooth zoom-based reveal
        var secondaryMarkers = [];
        var ZOOM_START = 6;  // begin fading in
        var ZOOM_FULL  = 9;  // fully expanded

        var markerIndex = 0;
        Object.keys(groups).forEach(function(key) {
          var group = groups[key];
          var count = group.length;

          group.forEach(function(story, gi) {
            var isSecondary = count > 1 && gi > 0;

            var container = document.createElement('div');
            container.className = 'story-marker-container';

            var img = document.createElement('div');
            img.className = 'story-marker';
            img.style.animationDelay = (markerIndex * 0.1) + 's';
            img.style.backgroundImage = 'url(' + story.photo + ')';

            var label = document.createElement('div');
            label.className = 'story-marker-label';
            label.textContent = story.label;

            container.appendChild(img);
            container.appendChild(label);

            container.addEventListener('click', function() {
              openStoryLightbox(story);
              map.flyTo({
                center: [story.lng, story.lat],
                zoom: Math.max(map.getZoom(), 8),
                duration: 1200
              });
            });

            // Calculate target offset & rotation for fully expanded state
            var targetOffset = [0, 0];

            if (count === 2 && gi > 0) {
              targetOffset = [22, 0];
              container.style.transformOrigin = 'bottom center';
              img.style.transform = 'rotate(8deg)';
            } else if (count >= 3 && gi > 0) {
              var radius = 30 + count * 2;
              var angle = (gi / count) * 2 * Math.PI - Math.PI / 2;
              targetOffset = [
                Math.cos(angle) * radius,
                Math.sin(angle) * radius
              ];
              var rot = (gi / count) * 360 - 90;
              img.style.transform = 'rotate(' + (rot * 0.15) + 'deg)';
            }

            if (isSecondary) {
              container.style.opacity = '0';
              container.style.pointerEvents = 'none';
            }

            var marker = new maplibregl.Marker({ element: container, anchor: 'bottom', offset: [0, 0] })
              .setLngLat([story.lng, story.lat])
              .addTo(map);

            if (isSecondary) {
              secondaryMarkers.push({
                el: container,
                marker: marker,
                targetOffset: targetOffset
              });
            }

            markerIndex++;
          });
        });

        // Smooth zoom-based reveal: lerp offset & opacity between ZOOM_START and ZOOM_FULL
        function updateMarkerVisibility() {
          var zoom = map.getZoom();
          // t goes from 0 (fully collapsed) to 1 (fully expanded)
          var t = Math.max(0, Math.min(1, (zoom - ZOOM_START) / (ZOOM_FULL - ZOOM_START)));
          // Ease-out for smoother feel
          var eased = 1 - Math.pow(1 - t, 3);

          secondaryMarkers.forEach(function(item) {
            var ox = item.targetOffset[0] * eased;
            var oy = item.targetOffset[1] * eased;
            item.marker.setOffset([ox, oy]);
            item.el.style.opacity = String(eased);
            item.el.style.pointerEvents = eased > 0.3 ? 'auto' : 'none';
          });
        }

        map.on('zoom', updateMarkerVisibility);
        updateMarkerVisibility();
      });

      // Lightbox logic
      var lightbox = document.getElementById('lightbox');
      var lightboxImg = document.getElementById('lightbox-img');
      var lightboxLocation = document.getElementById('lightbox-location');
      var lightboxDate = document.getElementById('lightbox-date');
      var lightboxDesc = document.getElementById('lightbox-description');
      var lightboxClose = document.getElementById('lightbox-close');

      function openStoryLightbox(story) {
        lightboxImg.src = story.photo;
        lightboxImg.alt = story.label;
        lightboxLocation.textContent = story.label;
        lightboxDesc.textContent = story.description || '';
        lightboxDesc.style.display = story.description ? 'block' : 'none';

        var d = new Date(story.date + 'T12:00:00');
        lightboxDate.textContent = d.toLocaleDateString(undefined, {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });

        lightbox.classList.remove('hidden');
        lightbox.classList.add('active');
      }

      function closeStoryLightbox() {
        lightbox.classList.add('hidden');
        lightbox.classList.remove('active');
      }

      lightboxClose.addEventListener('click', closeStoryLightbox);
      lightbox.addEventListener('click', function(e) {
        if (e.target === lightbox) closeStoryLightbox();
      });

      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closeStoryLightbox();
      });
    }

    // Init on page load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initStoriesMap);
    } else {
      initStoriesMap();
    }
    document.addEventListener('astro:page-load', initStoriesMap);
  </script>
</Layout>

<style is:global>
  /* Map takes full viewport */
  #stories-map {
    width: 100%;
    height: 100vh;
  }

  /* Custom marker: circular photo */
  .story-marker {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    border: 3px solid rgba(201, 169, 107, 0.8);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5), 0 0 15px rgba(201, 169, 107, 0.15);
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    object-fit: cover;
    background-color: #1a1a2e;
    background-size: cover;
    background-position: center;
  }

  .story-marker:hover {
    scale: 1.2;
    border-color: rgba(201, 169, 107, 1);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6), 0 0 25px rgba(201, 169, 107, 0.3);
    z-index: 10 !important;
  }

  /* Marker label */
  .story-marker-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
  }

  .story-marker-label {
    font-family: 'Montserrat', sans-serif;
    font-size: 0.625rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: rgba(255, 255, 255, 0.85);
    background: rgba(17, 24, 39, 0.85);
    backdrop-filter: blur(8px);
    padding: 3px 8px;
    border-radius: 4px;
    white-space: nowrap;
    border: 1px solid rgba(201, 169, 107, 0.2);
    pointer-events: none;
    opacity: 0;
    transform: translateY(4px);
    transition: opacity 0.2s ease, transform 0.2s ease;
  }

  .story-marker-container:hover .story-marker-label {
    opacity: 1;
    transform: translateY(0);
  }

  /* Marker entrance animation — applied to a wrapper inside
     the container. Uses scale via a CSS custom prop so it
     composes with the JS-applied rotate(). */
  @keyframes marker-pop-in {
    0% {
      opacity: 0;
      scale: 0.3;
    }
    60% {
      scale: 1.1;
    }
    100% {
      opacity: 1;
      scale: 1;
    }
  }

  .story-marker {
    animation: marker-pop-in 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    opacity: 0;
  }

  /* Lightbox transitions */
  #lightbox {
    transition: opacity 0.3s ease;
  }

  #lightbox.active {
    display: flex;
    opacity: 1;
  }

  #lightbox img {
    transition: transform 0.3s ease;
  }

  /* Hide maplibre attribution for cleaner look */
  .maplibregl-ctrl-attrib {
    opacity: 0.3;
    font-size: 10px !important;
  }

  .maplibregl-ctrl-attrib:hover {
    opacity: 0.8;
  }

  /* Mobile adjustments */
  @media (max-width: 768px) {
    .story-marker {
      width: 48px;
      height: 48px;
      border-width: 2px;
    }

    .story-marker-label {
      font-size: 0.5625rem;
    }
  }
</style>
