---
import Layout from '../../layouts/Layout.astro';
import Footer from '../../components/Footer.astro';
import FloatingHomeNav from '../../components/FloatingHomeNav.astro';
import { useTranslations, languages, type Languages } from '../../i18n/utils';
import moviesData from '../../data/movies.json';

export function getStaticPaths() {
  return Object.keys(languages).map(lang => ({
    params: { lang }
  }));
}

const { lang } = Astro.params;
const typedLang = lang as Languages;
const t = useTranslations(typedLang);

const allMovies = moviesData;
---

<Layout 
  title="Movie Ratings - Balla Botond"
  description="My personal movie ratings and reviews"
  keywords="movies, ratings, reviews, cinema"
>
  <!-- Floating Home Navigation -->
  <FloatingHomeNav />

  <main class="min-h-screen pt-24 sm:pt-28 md:pt-32 pb-16 md:pb-20 px-4 sm:px-6">
    <div class="max-w-5xl mx-auto">
      <!-- Header -->
      <div class="mb-8 md:mb-12 text-center">
        <h1 class="font-playfair text-3xl sm:text-4xl md:text-6xl font-medium mb-3 md:mb-4 pb-2 text-white leading-tight">
          {t('movies.title')}
        </h1>
        <p class="font-montserrat text-base md:text-lg text-luxury-gray px-4">
          {t('movies.description')}
        </p>
      </div>

      <!-- Filter Controls -->
      <div class="mb-6 md:mb-8 bg-gradient-to-br from-[#1d0f2f]/80 via-[#0f1b2d]/80 to-[#0a1c24]/80 backdrop-blur-md rounded-xl md:rounded-2xl p-4 md:p-6 border border-[#2c2140] shadow-lg shadow-[#0f1020]/40">
        <div class="flex flex-col md:flex-row md:flex-wrap gap-4 md:gap-4 items-stretch md:items-center justify-between">
          <!-- Rating Filter -->
          <div class="w-full sm:flex-1 md:min-w-[200px]">
            <label class="block text-sm font-medium font-montserrat text-luxury-gray mb-2">
              Filter by Rating
            </label>
            <select id="rating-filter-select" class="w-full bg-gray-700 bg-opacity-50 border border-gray-600 rounded-lg px-3 md:px-4 py-2.5 md:py-2 text-white font-montserrat text-sm md:text-base focus:ring-2 focus:ring-luxury-gold focus:border-transparent transition-all">
              <option value="all">All Movies</option>
              <option value="wtw">Want to Watch</option>
              <option value="good">Good</option>
              <option value="medium">Medium</option>
              <option value="bad">Bad</option>
            </select>
          </div>

          <!-- Sort Controls -->
          <div class="w-full sm:flex-1 md:min-w-[200px]">
            <label class="block text-sm font-medium font-montserrat text-luxury-gray mb-2">
              Sort by
            </label>
            <select id="sort-select" class="w-full bg-gray-700 bg-opacity-50 border border-gray-600 rounded-lg px-3 md:px-4 py-2.5 md:py-2 text-white font-montserrat text-sm md:text-base focus:ring-2 focus:ring-luxury-gold focus:border-transparent transition-all">
              <option value="rating-desc">Highest Rated</option>
              <option value="rating-asc">Lowest Rated</option>
              <option value="title-asc">Title (A-Z)</option>
              <option value="title-desc">Title (Z-A)</option>
            </select>
          </div>

          <!-- Per Page Controls -->
          <div class="w-full sm:flex-1 md:min-w-[160px]">
            <label class="block text-sm font-medium font-montserrat text-luxury-gray mb-2">
              Per page
            </label>
            <select id="per-page-select" class="w-full bg-gray-700 bg-opacity-50 border border-gray-600 rounded-lg px-3 md:px-4 py-2.5 md:py-2 text-white font-montserrat text-sm md:text-base focus:ring-2 focus:ring-luxury-gold focus:border-transparent transition-all">
              <option value="25">25</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
          </div>
        </div>

        <!-- Search -->
        <div class="mt-4">
          <input 
            type="text" 
            id="search-input" 
            placeholder="Search movies..." 
            class="w-full bg-gray-700 bg-opacity-50 border border-gray-600 rounded-lg px-3 md:px-4 py-2.5 md:py-2 text-white font-montserrat placeholder-gray-400 text-sm md:text-base focus:ring-2 focus:ring-luxury-gold focus:border-transparent transition-all"
          />
        </div>
      </div>

      <!-- Movies Grid -->
      <div id="movies-container" class="mb-12">
        <!-- Movies will be rendered here by JavaScript -->
      </div>

      <!-- Pagination -->
      <div id="pagination" class="flex flex-wrap justify-center items-center gap-1.5 sm:gap-2">
        <!-- Pagination will be rendered here by JavaScript -->
      </div>
    </div>
  </main>
  
  <!-- Footer Component -->
  <Footer variant="full" />
</Layout>

<style>
  .rating-btn {
    @apply bg-gray-700 bg-opacity-30 text-luxury-gray hover:bg-luxury-gold hover:bg-opacity-20 hover:text-luxury-gold border border-gray-600;
    font-family: 'Montserrat', sans-serif;
  }
  
  .rating-btn.active {
    @apply bg-luxury-gold bg-opacity-20 text-luxury-gold border-luxury-gold shadow-lg;
  }
</style>

<style is:global>
  .movie-card {
    display: block;
    width: 100%;
    padding: 1.5rem 1rem;
    border-radius: 0.75rem;
    background: linear-gradient(to bottom right, rgba(20, 24, 40, 0.85), rgba(17, 20, 37, 0.85), rgba(12, 16, 32, 0.9));
    backdrop-filter: blur(12px);
    border: 1px solid rgba(201, 169, 107, 0.25);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    transition: all 0.3s ease;
    text-decoration: none;
  }

  .movie-card.want-to-watch {
    background: linear-gradient(to bottom right, rgba(255, 107, 107, 0.1), rgba(255, 135, 135, 0.08), rgba(255, 107, 107, 0.05));
    border: 1.5px solid rgba(255, 107, 107, 0.4);
    box-shadow: 0 0 20px rgba(255, 107, 107, 0.15), 0 2px 8px rgba(0, 0, 0, 0.2);
  }

  .movie-card.want-to-watch:hover {
    border-color: rgba(255, 107, 107, 0.6);
    box-shadow: 0 0 30px rgba(255, 107, 107, 0.25), 0 4px 16px rgba(0, 0, 0, 0.3);
  }

  @media (min-width: 640px) {
    .movie-card {
      padding: 1.5rem 1.25rem;
    }
  }

  @media (min-width: 768px) {
    .movie-card {
      padding: 2rem 1.5rem;
      border-radius: 1rem;
    }
  }

  .movie-card:hover {
    transform: scale(1.02);
    border-color: rgba(201, 169, 107, 0.5);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
  }

  @media (min-width: 768px) {
    .movie-card:hover {
      transform: scale(1.05);
    }
  }

  .rating-circles {
    display: flex;
    gap: 3px;
    align-items: center;
    flex-shrink: 0;
  }

  @media (min-width: 640px) {
    .rating-circles {
      gap: 4px;
    }
  }

  .rating-circle {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    border: 1px solid;
    transition: all 0.3s ease;
    flex-shrink: 0;
  }

  @media (min-width: 640px) {
    .rating-circle {
      width: 9px;
      height: 9px;
    }
  }

  @media (min-width: 768px) {
    .rating-circle {
      width: 10px;
      height: 10px;
    }
  }

  .rating-circle.filled {
    background: #c9a96b;
    border-color: #c9a96b;
  }

  .rating-circle.half {
    border-color: #c9a96b;
    background: linear-gradient(90deg, #c9a96b 50%, transparent 50%);
  }

  .rating-circle.empty {
    border-color: #3e4555;
    background: transparent;
  }

  .wtw-badge {
    display: inline-block;
    background: linear-gradient(135deg, #ff6b6b 0%, #ff8787 100%);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    font-family: 'Montserrat', sans-serif;
    font-weight: 600;
    font-size: 0.875rem;
    white-space: nowrap;
    box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
    border: 1px solid rgba(255, 107, 107, 0.5);
  }

  .rating-value {
    color: #c9a96b;
    font-family: 'Montserrat', sans-serif;
    font-weight: 600;
    font-size: 0.875rem;
    margin-left: 0.5rem;
    white-space: nowrap;
  }

  .page-btn {
    @apply px-3 sm:px-4 py-2 sm:py-2.5 rounded-lg font-medium font-montserrat transition-all duration-200 bg-gray-700 bg-opacity-30 text-luxury-gray hover:bg-luxury-gold hover:bg-opacity-20 hover:text-luxury-gold border border-gray-600 disabled:opacity-50 disabled:cursor-not-allowed text-sm sm:text-base;
    min-width: 44px;
    min-height: 44px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  .page-btn.active {
    @apply bg-luxury-gold bg-opacity-20 text-luxury-gold border-luxury-gold;
  }
</style>

<style>
  /* Explicit spacing between movie items */
  #movies-container {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
    margin-bottom: 1.5rem;
  }

  @media (min-width: 640px) {
    #movies-container {
      gap: 1.75rem;
      margin-bottom: 2rem;
    }
  }

  @media (min-width: 768px) {
    #movies-container {
      gap: 2rem;
      margin-bottom: 2.5rem;
    }
  }
</style>

<script define:vars={{ allMovies }}>
  // Round rating to nearest 0.5
  function roundRating(rating) {
    if (!rating || rating === 0) return 0;
    return Math.round(rating * 2) / 2;
  }

  let movies = allMovies.map(movie => ({
    ...movie,
    rating: movie.rating ? roundRating(movie.rating) : 0
  }));
  let filteredMovies = [...movies];
  let currentPage = 1;
  let moviesPerPage = 25;
  let currentRatingFilter = 'all';
  let currentSort = 'rating-desc';
  let searchQuery = '';

  // Generate rating circles HTML
  function generateRatingCircles(rating) {
    // For want to watch movies (no rating or 0)
    if (!rating || rating === 0) {
      return '<div class="wtw-badge">Want to Watch</div>';
    }
    
    let circles = '';
    const roundedRating = roundRating(rating);
    
    for (let i = 1; i <= 10; i++) {
      if (i <= Math.floor(roundedRating)) {
        circles += '<div class="rating-circle filled"></div>';
      } else if (i === Math.ceil(roundedRating) && roundedRating % 1 !== 0) {
        circles += '<div class="rating-circle half"></div>';
      } else {
        circles += '<div class="rating-circle empty"></div>';
      }
    }
    
    return circles;
  }

  // Filter movies
  function filterMovies() {
    filteredMovies = movies.filter(movie => {
      // Check if movie is in want to watch category
      const isWantToWatch = !movie.rating || movie.rating === 0;
      
      // Rating filter
      let ratingMatch = true;
      if (currentRatingFilter === 'wtw') {
        ratingMatch = isWantToWatch;
      } else if (currentRatingFilter === 'all') {
        ratingMatch = true;
      } else if (currentRatingFilter === 'good') {
        ratingMatch = !isWantToWatch && movie.rating >= 8 && movie.rating <= 10;
      } else if (currentRatingFilter === 'medium') {
        ratingMatch = !isWantToWatch && movie.rating >= 4 && movie.rating < 8;
      } else if (currentRatingFilter === 'bad') {
        ratingMatch = !isWantToWatch && movie.rating >= 1 && movie.rating < 4;
      }
      
      // Search filter
      const searchMatch = searchQuery === '' || 
        movie.title.toLowerCase().includes(searchQuery.toLowerCase());
      
      return ratingMatch && searchMatch;
    });

    // Sort movies
    sortMovies();
    
    // Reset to first page
    currentPage = 1;
    renderMovies();
    renderPagination();
  }

  // Sort movies
  function sortMovies() {
    switch(currentSort) {
      case 'rating-desc':
        filteredMovies.sort((a, b) => {
          const aRating = !a.rating || a.rating === 0 ? -1 : a.rating;
          const bRating = !b.rating || b.rating === 0 ? -1 : b.rating;
          return bRating - aRating;
        });
        break;
      case 'rating-asc':
        filteredMovies.sort((a, b) => {
          const aRating = !a.rating || a.rating === 0 ? 11 : a.rating;
          const bRating = !b.rating || b.rating === 0 ? 11 : b.rating;
          return aRating - bRating;
        });
        break;
      case 'title-asc':
        filteredMovies.sort((a, b) => a.title.localeCompare(b.title));
        break;
      case 'title-desc':
        filteredMovies.sort((a, b) => b.title.localeCompare(a.title));
        break;
    }
  }

  // Render movies
  function renderMovies() {
    const container = document.getElementById('movies-container');
    const start = (currentPage - 1) * moviesPerPage;
    const end = start + moviesPerPage;
    const moviesToShow = filteredMovies.slice(start, end);

    if (moviesToShow.length === 0) {
      container.innerHTML = `
        <div class="text-center py-12">
          <p class="text-gray-400 text-lg">No movies found</p>
        </div>
      `;
      return;
    }

    container.innerHTML = moviesToShow.map(movie => {
      const searchUrl = `https://www.themoviedb.org/search?query=${encodeURIComponent(movie.title)}`;
      const isWantToWatch = !movie.rating || movie.rating === 0;
      const ratingDisplay = isWantToWatch ? '' : `<span class="rating-value">${movie.rating.toFixed(1)}</span>`;
      return `
      <a class="movie-card ${isWantToWatch ? 'want-to-watch' : ''}" href="${searchUrl}" target="_blank" rel="noreferrer">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 sm:gap-4 md:gap-6">
          <h3 class="font-playfair text-xl sm:text-2xl font-medium text-white flex-1 leading-tight">${movie.title}</h3>
          <div class="rating-circles">
            ${generateRatingCircles(movie.rating)}
            ${ratingDisplay}
          </div>
        </div>
      </a>
    `;
    }).join('');
  }

  // Render pagination
  function renderPagination() {
    const pagination = document.getElementById('pagination');
    const totalPages = Math.ceil(filteredMovies.length / moviesPerPage);

    if (totalPages <= 1) {
      pagination.innerHTML = '';
      return;
    }

    let buttons = '';

    // Previous button
    buttons += `
      <button 
        class="page-btn" 
        onclick="changePage(${currentPage - 1})" 
        ${currentPage === 1 ? 'disabled' : ''}
      >
        ← Prev
      </button>
    `;

    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
      if (
        i === 1 || 
        i === totalPages || 
        (i >= currentPage - 1 && i <= currentPage + 1)
      ) {
        buttons += `
          <button 
            class="page-btn ${i === currentPage ? 'active' : ''}" 
            onclick="changePage(${i})"
          >
            ${i}
          </button>
        `;
      } else if (i === currentPage - 2 || i === currentPage + 2) {
        buttons += '<span class="text-gray-500 px-2">...</span>';
      }
    }

    // Next button
    buttons += `
      <button 
        class="page-btn" 
        onclick="changePage(${currentPage + 1})" 
        ${currentPage === totalPages ? 'disabled' : ''}
      >
        Next →
      </button>
    `;

    pagination.innerHTML = buttons;
  }

  // Change page
  window.changePage = function(page) {
    const totalPages = Math.ceil(filteredMovies.length / moviesPerPage);
    if (page < 1 || page > totalPages) return;
    currentPage = page;
    renderMovies();
    renderPagination();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // Initialize function
  function initializeMovies() {
    // Reset state
    currentPage = 1;
    currentRatingFilter = 'all';
    currentSort = 'rating-desc';
    searchQuery = '';
    
    // Rating filter select
    const ratingFilterSelect = document.getElementById('rating-filter-select');
    if (ratingFilterSelect) {
      ratingFilterSelect.value = 'all';
      ratingFilterSelect.addEventListener('change', (e) => {
        currentRatingFilter = e.target.value;
        filterMovies();
      });
    }

    // Sort select
    const sortSelect = document.getElementById('sort-select');
    if (sortSelect) {
      sortSelect.value = 'rating-desc';
      sortSelect.addEventListener('change', (e) => {
        currentSort = e.target.value;
        filterMovies();
      });
    }

    // Per page select
    const perPageSelect = document.getElementById('per-page-select');
    if (perPageSelect) {
      perPageSelect.value = String(moviesPerPage);
      perPageSelect.addEventListener('change', (e) => {
        const val = parseInt(e.target.value, 10);
        moviesPerPage = Number.isNaN(val) ? 50 : val;
        currentPage = 1;
        renderMovies();
        renderPagination();
      });
    }

    // Search input
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
      searchInput.value = '';
      searchInput.addEventListener('input', (e) => {
        searchQuery = e.target.value;
        filterMovies();
      });
    }

    // Initial render
    filterMovies();
  }

  // Listen for both DOMContentLoaded and Astro page loads
  document.addEventListener('DOMContentLoaded', initializeMovies);
  document.addEventListener('astro:page-load', initializeMovies);
</script>
