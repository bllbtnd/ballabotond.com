---
// Calendar availability page for Balla Botond's Astro site
// Shows availability without revealing actual event details (privacy-focused)
import Layout from '../../layouts/Layout.astro';
import Footer from '../../components/Footer.astro';
import Constellation from '../../components/Constellation.astro';
import BackgroundGradient from '../../components/BackgroundGradient.astro';
import FloatingHomeNav from '../../components/FloatingHomeNav.astro';
import { useTranslations, useTranslatedPath, languages, type Languages } from '../../i18n/utils';
import { fetchCalendars, getAvailability, groupByWeek } from '../../utils/calendar';

export function getStaticPaths() {
  return Object.keys(languages).map(lang => ({
    params: { lang }
  }));
}

const { lang } = Astro.params;
const typedLang = lang as Languages;
const t = useTranslations(typedLang);
const translatePath = useTranslatedPath(typedLang);

const calendarUrls = import.meta.env.PUBLIC_CALENDAR_URLS?.split(',').map((url: string) => url.trim()).filter(Boolean) || [];

let availability: ReturnType<typeof getAvailability> = [];
let weeks: ReturnType<typeof groupByWeek> = [];

if (calendarUrls.length > 0) {
  try {
    const busySlots = await fetchCalendars(calendarUrls);
    availability = getAvailability(busySlots, 4);
    weeks = groupByWeek(availability);
  } catch (error) {
    console.error('Failed to fetch calendar data:', error);
  }
}

const formatDate = (date: Date) => {
  return date.toLocaleDateString(typedLang, { month: 'short', day: 'numeric' });
};

const getDayName = (date: Date) => {
  return date.toLocaleDateString(typedLang, { weekday: 'short' });
};

const isToday = (date: Date) => {
  const today = new Date();
  return date.getDate() === today.getDate() &&
         date.getMonth() === today.getMonth() &&
         date.getFullYear() === today.getFullYear();
};

const hours = Array.from({ length: 17 }, (_, i) => i + 6);
const labeledHours = [6, 9, 12, 15, 18, 21];
---

<Layout 
  title={t('calendar.title')}
  description={t('calendar.description')}
  keywords={t('calendar.keywords')}
>
  <BackgroundGradient />
  <Constellation />
  <FloatingHomeNav lang={typedLang} />

  <div class="calendar-wrapper">
    <!-- Calendar viewport (fixed to screen) -->
    <main class="calendar-main">
      <!-- Header -->
      <header class="cal-header">
        <h1 class="font-playfair text-xl md:text-2xl font-light text-white tracking-wide">
          {t('calendar.subtitle')}
        </h1>
        <div class="flex items-center justify-center gap-3 mt-0.5">
          <div class="h-px w-8 bg-luxury-gold/40"></div>
          <p class="font-montserrat text-[10px] text-luxury-gold uppercase tracking-[0.2em]">
            {t('calendar.tagline')}
          </p>
          <div class="h-px w-8 bg-luxury-gold/40"></div>
        </div>
      </header>

      {calendarUrls.length === 0 ? (
        <div class="flex-1 flex items-center justify-center px-4">
          <div class="bg-white/5 backdrop-blur-sm rounded-xl border border-luxury-gold/20 p-8 text-center max-w-md">
            <div class="mb-4">
              <i class="fas fa-calendar-times text-luxury-gold/40 text-4xl"></i>
            </div>
            <p class="text-gray-300 text-sm leading-relaxed font-montserrat">
              {t('calendar.noCalendars')}
            </p>
          </div>
        </div>
      ) : (
        <div class="cal-container">
          <!-- Swipe hint (mobile only) -->
          <div class="cal-swipe-hint">
            <div class="cal-swipe-hint-content">
              <i class="fas fa-chevron-left"></i>
              <span>{t('calendar.swipeHint')}</span>
              <i class="fas fa-chevron-right"></i>
            </div>
          </div>
          
          <!-- Week indicator (mobile only) -->
          <div class="cal-week-indicator">
            {weeks.map((_, idx) => (
              <div class="cal-week-dot" data-week={idx}></div>
            ))}
          </div>
          
          <!-- Grid: 4 weeks -->
          <div class="cal-grid" id="calGrid">
            {weeks.map((week, weekIdx) => (
              <div class="cal-week" data-week={weekIdx}>
                <!-- Hour gutter -->
                <div class="cal-gutter">
                  <div class="cal-gutter-header"></div>
                  <div class="cal-gutter-hours">
                    {hours.map((hour) => (
                      <div class="cal-gutter-cell">
                        {labeledHours.includes(hour) && (
                          <span>{hour}</span>
                        )}
                      </div>
                    ))}
                  </div>
                </div>

                {/* 7 day columns */}
                {week.map((day) => (
                  <div class={`cal-day ${day.isPast ? 'cal-day--past' : ''} ${isToday(day.date) ? 'cal-day--today' : ''}`}>
                    {/* Day header */}
                    <div class="cal-day-header">
                      <span class="cal-day-name">{getDayName(day.date)}</span>
                      <span class="cal-day-num">{day.date.getDate()}</span>
                    </div>
                    {/* Hour cells */}
                    <div class="cal-day-hours">
                      {day.hourlyAvailability?.map((avail, hi) => (
                        <div 
                          class={`cal-cell ${avail ? 'cal-cell--free' : 'cal-cell--busy'}`}
                          title={`${hi + 6}:00 – ${hi + 7}:00 · ${avail ? t('calendar.available') : t('calendar.busy')}`}
                        />
                      ))}
                    </div>
                  </div>
                ))}
              </div>
            ))}
          </div>
        </div>
      )}

      <!-- Legend -->
      <footer class="cal-legend">
        <div class="flex items-center gap-1.5">
          <div class="w-2 h-2 rounded-sm bg-emerald-400/40 border border-emerald-400/50"></div>
          <span>{t('calendar.available')}</span>
        </div>
        <div class="flex items-center gap-1.5">
          <div class="w-2 h-2 rounded-sm bg-rose-400/40 border border-rose-400/50"></div>
          <span>{t('calendar.busy')}</span>
        </div>
        <div class="flex items-center gap-1.5">
          <div class="w-2 h-2 rounded-sm bg-white/5 border border-white/10"></div>
          <span>{t('calendar.past') ?? 'Past'}</span>
        </div>
        <span class="cal-legend-privacy">{t('calendar.privacyNote')}</span>
      </footer>
    </main>

    <!-- Scrollable footer below the fold -->
    <Footer />
  </div>
</Layout>

<style>
  /* ─── Layout ─── */
  .calendar-wrapper {
    position: relative;
    z-index: 10;
  }
  .calendar-main {
    height: 100vh;
    display: flex;
    flex-direction: column;
    padding: 3rem 1rem 0.5rem;
    overflow: hidden;
  }

  /* ─── Header ─── */
  .cal-header {
    text-align: center;
    flex-shrink: 0;
    margin-bottom: 0.5rem;
  }

  /* ─── Container ─── */
  .cal-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 0;
    position: relative;
  }

  /* ─── Swipe Hint (mobile only) ─── */
  .cal-swipe-hint {
    display: none;
  }

  /* ─── Week Indicator (mobile only) ─── */
  .cal-week-indicator {
    display: none;
  }

  /* ─── Grid: 4 week rows ─── */
  .cal-grid {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 2px;
    min-height: 0;
  }

  /* Each week row */
  .cal-week {
    flex: 1;
    display: flex;
    gap: 1px;
    min-height: 0;
    background: rgba(255,255,255,0.03);
    border-radius: 6px;
    overflow: hidden;
  }

  /* ─── Hour gutter ─── */
  .cal-gutter {
    width: 20px;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
  }
  .cal-gutter-header {
    height: 28px;
    flex-shrink: 0;
  }
  .cal-gutter-hours {
    flex: 1;
    display: flex;
    flex-direction: column;
  }
  .cal-gutter-cell {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding-right: 3px;
  }
  .cal-gutter-cell span {
    font-family: 'Montserrat', sans-serif;
    font-size: 7px;
    color: rgba(255,255,255,0.25);
    line-height: 1;
  }

  /* ─── Day column ─── */
  .cal-day {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
    border-left: 1px solid rgba(255,255,255,0.04);
  }

  /* Day header */
  .cal-day-header {
    height: 28px;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0;
    padding: 2px 0;
    border-bottom: 1px solid rgba(255,255,255,0.06);
  }
  .cal-day-name {
    font-family: 'Montserrat', sans-serif;
    font-size: 8px;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: rgba(255,255,255,0.35);
    line-height: 1;
  }
  .cal-day-num {
    font-family: 'Montserrat', sans-serif;
    font-size: 11px;
    font-weight: 600;
    color: rgba(255,255,255,0.7);
    line-height: 1.1;
  }

  /* Today styling */
  .cal-day--today .cal-day-header {
    background: rgba(201, 169, 107, 0.12);
    border-bottom-color: rgba(201, 169, 107, 0.3);
  }
  .cal-day--today .cal-day-name {
    color: #c9a96b;
  }
  .cal-day--today .cal-day-num {
    color: #c9a96b;
  }

  /* Past day styling */
  .cal-day--past {
    opacity: 0.3;
  }
  .cal-day--past .cal-day-hours {
    pointer-events: none;
  }

  /* ─── Hour cells ─── */
  .cal-day-hours {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0;
  }
  .cal-cell {
    flex: 1;
    transition: background 0.15s ease;
    cursor: default;
    border-bottom: 1px solid rgba(0,0,0,0.15);
  }
  .cal-cell--free {
    background: rgba(52, 211, 153, 0.12);
  }
  .cal-cell--busy {
    background: rgba(251, 113, 133, 0.18);
  }
  .cal-cell--free:hover {
    background: rgba(52, 211, 153, 0.28);
  }
  .cal-cell--busy:hover {
    background: rgba(251, 113, 133, 0.35);
  }

  /* ─── Legend ─── */
  .cal-legend {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    padding-top: 0.4rem;
    margin-top: 0.25rem;
    border-top: 1px solid rgba(255,255,255,0.06);
  }
  .cal-legend span {
    font-family: 'Montserrat', sans-serif;
    font-size: 9px;
    color: rgba(255,255,255,0.4);
  }
  .cal-legend-privacy {
    font-family: 'Montserrat', sans-serif;
    font-size: 8px !important;
    color: rgba(255,255,255,0.2) !important;
  }

  /* ─── Mobile ─── */
  @media (max-width: 640px) {
    .calendar-main {
      padding: 2.5rem 0.5rem 0.5rem;
    }
    .cal-header h1 {
      font-size: 1.25rem;
    }
    .cal-header {
      margin-bottom: 1rem;
    }
    
    /* Swipe hint - show briefly on mobile */
    .cal-swipe-hint {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 0.5rem 0 0.25rem;
      flex-shrink: 0;
      opacity: 0;
      animation: swipeHintFade 4s ease-in-out;
    }
    @keyframes swipeHintFade {
      0% { opacity: 0; }
      20% { opacity: 1; }
      80% { opacity: 1; }
      100% { opacity: 0; }
    }
    .cal-swipe-hint-content {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-family: 'Montserrat', sans-serif;
      font-size: 10px;
      color: rgba(201, 169, 107, 0.6);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .cal-swipe-hint-content i {
      font-size: 8px;
      color: rgba(201, 169, 107, 0.4);
    }
    
    /* Week indicator - show on mobile */
    .cal-week-indicator {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      padding: 0.5rem 0;
      flex-shrink: 0;
    }
    .cal-week-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
      cursor: pointer;
    }
    .cal-week-dot.active {
      background: #c9a96b;
      width: 24px;
      border-radius: 4px;
      box-shadow: 0 0 8px rgba(201, 169, 107, 0.4);
    }
    
    /* Mobile: Show one week at a time */
    .cal-grid {
      gap: 0;
      overflow-x: auto;
      overflow-y: hidden;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE and Edge */
      padding: 0 0.5rem;
      scroll-behavior: smooth;
    }
    .cal-grid::-webkit-scrollbar {
      display: none; /* Chrome, Safari, Opera */
    }
    
    .cal-week {
      min-width: 100%;
      flex-shrink: 0;
      scroll-snap-align: start;
      margin-bottom: 0.5rem;
      border-radius: 8px;
      padding: 0.25rem;
    }
    
    /* Larger touch targets on mobile */
    .cal-gutter { 
      width: 28px;
      padding-right: 4px;
    }
    .cal-gutter-header { 
      height: 42px; 
    }
    .cal-gutter-cell {
      padding-right: 6px;
    }
    .cal-gutter-cell span { 
      font-size: 9px;
      font-weight: 500;
      color: rgba(201, 169, 107, 0.5);
    }
    
    .cal-day-header { 
      height: 42px;
      gap: 2px;
      padding: 4px 0;
    }
    .cal-day-name { 
      font-size: 9px;
      font-weight: 600;
      letter-spacing: 0.08em;
      color: rgba(255,255,255,0.5);
    }
    .cal-day-num { 
      font-size: 15px;
      font-weight: 700;
      color: rgba(255,255,255,0.85);
    }
    
    /* Today styling - more prominent on mobile */
    .cal-day--today .cal-day-header {
      background: rgba(201, 169, 107, 0.2);
      border-bottom-color: rgba(201, 169, 107, 0.4);
      border-radius: 4px 4px 0 0;
    }
    .cal-day--today .cal-day-name {
      color: #e8c474;
      font-weight: 700;
    }
    .cal-day--today .cal-day-num {
      color: #e8c474;
    }
    
    /* Larger cells for better touch targets */
    .cal-cell {
      min-height: 20px;
      border-bottom: 1px solid rgba(0,0,0,0.2);
      border-radius: 2px;
      margin-bottom: 1px;
    }
    .cal-cell--free {
      background: rgba(52, 211, 153, 0.18);
      border-left: 2px solid rgba(52, 211, 153, 0.4);
    }
    .cal-cell--busy {
      background: rgba(251, 113, 133, 0.22);
      border-left: 2px solid rgba(251, 113, 133, 0.5);
    }
    
    /* Legend styling */
    .cal-legend { 
      gap: 0.75rem; 
      flex-wrap: wrap;
      padding-top: 0.75rem;
      margin-top: 0.5rem;
      justify-content: space-around;
    }
    .cal-legend span {
      font-size: 10px;
      font-weight: 500;
      color: rgba(255,255,255,0.6);
    }
    .cal-legend > div {
      display: flex;
      align-items: center;
      gap: 0.375rem;
    }
    .cal-legend > div > div {
      width: 12px;
      height: 12px;
      border-radius: 3px;
    }
    .cal-legend-privacy { 
      display: none; 
    }
  }
</style>

<script>
  // Mobile week navigation with scroll indicator
  if (typeof window !== 'undefined') {
    const mobileQuery = window.matchMedia('(max-width: 640px)');
    
    function initMobileNavigation() {
      if (!mobileQuery.matches) return;
      
      const grid = document.getElementById('calGrid');
      const dots = document.querySelectorAll('.cal-week-dot');
      
      if (!grid || dots.length === 0) return;
      
      // Debounce helper
      let scrollTimeout: number | null = null;
      
      // Update active dot based on scroll position
      const updateActiveDot = () => {
        const scrollLeft = grid.scrollLeft;
        const weekWidth = grid.scrollWidth / dots.length;
        const activeIndex = Math.round(scrollLeft / weekWidth);
        
        dots.forEach((dot, idx) => {
          if (idx === activeIndex) {
            dot.classList.add('active');
          } else {
            dot.classList.remove('active');
          }
        });
      };
      
      // Initial state
      updateActiveDot();
      
      // Debounced scroll handler
      const handleScroll = () => {
        if (scrollTimeout) {
          window.clearTimeout(scrollTimeout);
        }
        scrollTimeout = window.setTimeout(updateActiveDot, 50);
      };
      
      // Update on scroll (debounced)
      grid.addEventListener('scroll', handleScroll, { passive: true });
      
      // Click on dot to scroll to that week
      dots.forEach((dot, idx) => {
        dot.addEventListener('click', () => {
          const weekWidth = grid.scrollWidth / dots.length;
          grid.scrollTo({
            left: idx * weekWidth,
            behavior: 'smooth'
          });
        });
      });
      
      // Cleanup function
      return () => {
        grid.removeEventListener('scroll', handleScroll);
        if (scrollTimeout) {
          window.clearTimeout(scrollTimeout);
        }
      };
    }
    
    // Initialize on load
    let cleanup = initMobileNavigation();
    
    // Re-initialize on viewport resize
    mobileQuery.addEventListener('change', (e) => {
      if (cleanup) cleanup();
      cleanup = initMobileNavigation();
    });
  }
</script>
