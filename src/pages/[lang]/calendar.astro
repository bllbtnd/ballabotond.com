---
// Calendar availability page for Balla Botond's Astro site
// Shows availability without revealing actual event details (privacy-focused)
import Layout from '../../layouts/Layout.astro';
import Footer from '../../components/Footer.astro';
import Constellation from '../../components/Constellation.astro';
import BackgroundGradient from '../../components/BackgroundGradient.astro';
import FloatingHomeNav from '../../components/FloatingHomeNav.astro';
import { useTranslations, useTranslatedPath, languages, type Languages } from '../../i18n/utils';
import { fetchCalendars, getAvailability, groupByWeek } from '../../utils/calendar';

export function getStaticPaths() {
  return Object.keys(languages).map(lang => ({
    params: { lang }
  }));
}

const { lang } = Astro.params;
const typedLang = lang as Languages;
const t = useTranslations(typedLang);
const translatePath = useTranslatedPath(typedLang);

const calendarUrls = import.meta.env.PUBLIC_CALENDAR_URLS?.split(',').map((url: string) => url.trim()).filter(Boolean) || [];

let availability: ReturnType<typeof getAvailability> = [];
let weeks: ReturnType<typeof groupByWeek> = [];

if (calendarUrls.length > 0) {
  try {
    const busySlots = await fetchCalendars(calendarUrls);
    availability = getAvailability(busySlots, 4);
    weeks = groupByWeek(availability);
  } catch (error) {
    console.error('Failed to fetch calendar data:', error);
  }
}

const formatDate = (date: Date) => {
  return date.toLocaleDateString(typedLang, { month: 'short', day: 'numeric' });
};

const getDayName = (date: Date) => {
  return date.toLocaleDateString(typedLang, { weekday: 'short' });
};

const isToday = (date: Date) => {
  const today = new Date();
  return date.getDate() === today.getDate() &&
         date.getMonth() === today.getMonth() &&
         date.getFullYear() === today.getFullYear();
};

const hours = Array.from({ length: 17 }, (_, i) => i + 6);
const labeledHours = [6, 9, 12, 15, 18, 21];
---

<Layout 
  title={t('calendar.title')}
  description={t('calendar.description')}
  keywords={t('calendar.keywords')}
>
  <BackgroundGradient />
  <Constellation />
  <FloatingHomeNav lang={typedLang} />

  <div class="calendar-wrapper">
    <!-- Calendar viewport (fixed to screen) -->
    <main class="calendar-main">
      <!-- Header -->
      <header class="cal-header">
        <h1 class="font-playfair text-xl md:text-2xl font-light text-white tracking-wide">
          {t('calendar.subtitle')}
        </h1>
        <div class="flex items-center justify-center gap-3 mt-0.5">
          <div class="h-px w-8 bg-luxury-gold/40"></div>
          <p class="font-montserrat text-[10px] text-luxury-gold uppercase tracking-[0.2em]">
            {t('calendar.tagline')}
          </p>
          <div class="h-px w-8 bg-luxury-gold/40"></div>
        </div>
      </header>

      {calendarUrls.length === 0 ? (
        <div class="flex-1 flex items-center justify-center">
          <div class="bg-white/5 backdrop-blur-sm rounded-lg border border-white/10 p-6 text-center max-w-md">
            <p class="text-gray-400 text-sm">{t('calendar.noCalendars')}</p>
          </div>
        </div>
      ) : (
        <!-- Grid: 4 weeks -->
        <div class="cal-grid">
          {weeks.map((week) => (
            <div class="cal-week">
              <!-- Hour gutter -->
              <div class="cal-gutter">
                <div class="cal-gutter-header"></div>
                <div class="cal-gutter-hours">
                  {hours.map((hour) => (
                    <div class="cal-gutter-cell">
                      {labeledHours.includes(hour) && (
                        <span>{hour}</span>
                      )}
                    </div>
                  ))}
                </div>
              </div>

              {/* 7 day columns */}
              {week.map((day) => (
                <div class={`cal-day ${day.isPast ? 'cal-day--past' : ''} ${isToday(day.date) ? 'cal-day--today' : ''}`}>
                  {/* Day header */}
                  <div class="cal-day-header">
                    <span class="cal-day-name">{getDayName(day.date)}</span>
                    <span class="cal-day-num">{day.date.getDate()}</span>
                  </div>
                  {/* Hour cells */}
                  <div class="cal-day-hours">
                    {day.hourlyAvailability?.map((avail, hi) => (
                      <div 
                        class={`cal-cell ${avail ? 'cal-cell--free' : 'cal-cell--busy'}`}
                        title={`${hi + 6}:00 – ${hi + 7}:00 · ${avail ? t('calendar.available') : t('calendar.busy')}`}
                      />
                    ))}
                  </div>
                </div>
              ))}
            </div>
          ))}
        </div>
      )}

      <!-- Legend -->
      <footer class="cal-legend">
        <div class="flex items-center gap-1.5">
          <div class="w-2 h-2 rounded-sm bg-emerald-400/40 border border-emerald-400/50"></div>
          <span>{t('calendar.available')}</span>
        </div>
        <div class="flex items-center gap-1.5">
          <div class="w-2 h-2 rounded-sm bg-rose-400/40 border border-rose-400/50"></div>
          <span>{t('calendar.busy')}</span>
        </div>
        <div class="flex items-center gap-1.5">
          <div class="w-2 h-2 rounded-sm bg-white/5 border border-white/10"></div>
          <span>{t('calendar.past') ?? 'Past'}</span>
        </div>
        <span class="cal-legend-privacy">{t('calendar.privacyNote')}</span>
      </footer>
    </main>

    <!-- Scrollable footer below the fold -->
    <Footer />
  </div>
</Layout>

<style>
  /* ─── Layout ─── */
  .calendar-wrapper {
    position: relative;
    z-index: 10;
  }
  .calendar-main {
    height: 100vh;
    display: flex;
    flex-direction: column;
    padding: 3rem 1rem 0.5rem;
    overflow: hidden;
  }

  /* ─── Header ─── */
  .cal-header {
    text-align: center;
    flex-shrink: 0;
    margin-bottom: 0.5rem;
  }

  /* ─── Grid: 4 week rows ─── */
  .cal-grid {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 2px;
    min-height: 0;
  }

  /* Each week row */
  .cal-week {
    flex: 1;
    display: flex;
    gap: 1px;
    min-height: 0;
    background: rgba(255,255,255,0.03);
    border-radius: 6px;
    overflow: hidden;
  }

  /* ─── Hour gutter ─── */
  .cal-gutter {
    width: 20px;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
  }
  .cal-gutter-header {
    height: 28px;
    flex-shrink: 0;
  }
  .cal-gutter-hours {
    flex: 1;
    display: flex;
    flex-direction: column;
  }
  .cal-gutter-cell {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding-right: 3px;
  }
  .cal-gutter-cell span {
    font-family: 'Montserrat', sans-serif;
    font-size: 7px;
    color: rgba(255,255,255,0.25);
    line-height: 1;
  }

  /* ─── Day column ─── */
  .cal-day {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
    border-left: 1px solid rgba(255,255,255,0.04);
  }

  /* Day header */
  .cal-day-header {
    height: 28px;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0;
    padding: 2px 0;
    border-bottom: 1px solid rgba(255,255,255,0.06);
  }
  .cal-day-name {
    font-family: 'Montserrat', sans-serif;
    font-size: 8px;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: rgba(255,255,255,0.35);
    line-height: 1;
  }
  .cal-day-num {
    font-family: 'Montserrat', sans-serif;
    font-size: 11px;
    font-weight: 600;
    color: rgba(255,255,255,0.7);
    line-height: 1.1;
  }

  /* Today styling */
  .cal-day--today .cal-day-header {
    background: rgba(201, 169, 107, 0.12);
    border-bottom-color: rgba(201, 169, 107, 0.3);
  }
  .cal-day--today .cal-day-name {
    color: #c9a96b;
  }
  .cal-day--today .cal-day-num {
    color: #c9a96b;
  }

  /* Past day styling */
  .cal-day--past {
    opacity: 0.3;
  }
  .cal-day--past .cal-day-hours {
    pointer-events: none;
  }

  /* ─── Hour cells ─── */
  .cal-day-hours {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0;
  }
  .cal-cell {
    flex: 1;
    transition: background 0.15s ease;
    cursor: default;
    border-bottom: 1px solid rgba(0,0,0,0.15);
  }
  .cal-cell--free {
    background: rgba(52, 211, 153, 0.12);
  }
  .cal-cell--busy {
    background: rgba(251, 113, 133, 0.18);
  }
  .cal-cell--free:hover {
    background: rgba(52, 211, 153, 0.28);
  }
  .cal-cell--busy:hover {
    background: rgba(251, 113, 133, 0.35);
  }

  /* ─── Legend ─── */
  .cal-legend {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    padding-top: 0.4rem;
    margin-top: 0.25rem;
    border-top: 1px solid rgba(255,255,255,0.06);
  }
  .cal-legend span {
    font-family: 'Montserrat', sans-serif;
    font-size: 9px;
    color: rgba(255,255,255,0.4);
  }
  .cal-legend-privacy {
    font-family: 'Montserrat', sans-serif;
    font-size: 8px !important;
    color: rgba(255,255,255,0.2) !important;
  }

  /* ─── Mobile ─── */
  @media (max-width: 640px) {
    .calendar-main {
      padding: 2.5rem 0.25rem 0.25rem;
    }
    .cal-header h1 {
      font-size: 1.1rem;
    }
    .cal-gutter { width: 14px; }
    .cal-gutter-header { height: 22px; }
    .cal-gutter-cell span { font-size: 6px; }
    .cal-day-header { height: 22px; }
    .cal-day-name { font-size: 6px; }
    .cal-day-num { font-size: 9px; }
    .cal-legend { gap: 0.5rem; flex-wrap: wrap; }
    .cal-legend-privacy { display: none; }
  }
</style>
