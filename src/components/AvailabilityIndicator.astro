---
// Availability Indicator Component
// Shows current availability status as a colored dot
import { getLangFromUrl, useTranslatedPath } from '../i18n/utils';
import { fetchCalendars, getAvailability } from '../utils/calendar';

const lang = getLangFromUrl(Astro.url);
const translatePath = useTranslatedPath(lang);

const calendarUrls = import.meta.env.PUBLIC_CALENDAR_URLS?.split(',').map((url: string) => url.trim()).filter(Boolean) || [];

let isAvailable = false;
let showIndicator = false;

if (calendarUrls.length > 0) {
  try {
    const busySlots = await fetchCalendars(calendarUrls);
    const availability = getAvailability(busySlots, 1); // Only check current week
    
    // Find today's availability
    const now = new Date();
    const today = availability.find(day => {
      return day.date.getDate() === now.getDate() &&
             day.date.getMonth() === now.getMonth() &&
             day.date.getFullYear() === now.getFullYear();
    });
    
    if (today && !today.isPast && today.hourlyAvailability) {
      // Check current hour availability (6 AM to 10 PM range)
      const currentHour = now.getHours();
      if (currentHour >= 6 && currentHour <= 22) {
        const hourIndex = currentHour - 6; // Index 0 = 6 AM
        isAvailable = today.hourlyAvailability[hourIndex] === true;
        showIndicator = true;
      }
    }
  } catch (error) {
    console.error('Failed to fetch availability:', error);
  }
}
---

{showIndicator && (
  <a
    href={translatePath('/calendar')}
    class={`availability-dot ${isAvailable ? 'available' : 'busy'}`}
    id="availability-indicator"
    title={isAvailable ? 'Available - View calendar' : 'Busy - View calendar'}
  >
    <span class="sr-only">{isAvailable ? 'Available' : 'Busy'}</span>
  </a>
)}

<style>
  .availability-dot {
    position: fixed;
    bottom: 1.5rem;
    left: 1.5rem;
    z-index: 20;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    opacity: 0.8;
    box-shadow: 0 0 12px rgba(0, 0, 0, 0.3);
  }

  .availability-dot:hover {
    opacity: 1;
    transform: scale(1.2);
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
  }

  .availability-dot.available {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    box-shadow: 0 0 12px rgba(16, 185, 129, 0.4);
  }

  .availability-dot.available:hover {
    box-shadow: 0 0 20px rgba(16, 185, 129, 0.6);
  }

  .availability-dot.busy {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    box-shadow: 0 0 12px rgba(239, 68, 68, 0.4);
  }

  .availability-dot.busy:hover {
    box-shadow: 0 0 20px rgba(239, 68, 68, 0.6);
  }

  .availability-dot.scrolled-down {
    opacity: 0;
    pointer-events: none;
  }

  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
  }

  @media (max-width: 768px) {
    .availability-dot {
      width: 12px;
      height: 12px;
      bottom: 1.25rem;
      left: 1.25rem;
    }
  }
</style>

<script>
  let scrollHandler: (() => void) | null = null;

  function initAvailabilityIndicator() {
    const indicator = document.getElementById('availability-indicator');
    if (!(indicator instanceof HTMLElement)) return;

    // Remove old handler if exists
    if (scrollHandler) {
      window.removeEventListener('scroll', scrollHandler);
    }

    let lastScrollY = window.scrollY;
    const handleScroll = () => {
      const currentScrollY = window.scrollY;

      if (currentScrollY > 50) {
        if (currentScrollY > lastScrollY) {
          indicator.classList.add('scrolled-down');
        } else {
          indicator.classList.remove('scrolled-down');
        }
      } else {
        indicator.classList.remove('scrolled-down');
      }

      lastScrollY = currentScrollY;
    };

    scrollHandler = () => {
      requestAnimationFrame(handleScroll);
    };

    // Run once to sync initial state
    handleScroll();

    window.addEventListener('scroll', scrollHandler, { passive: true });
  }

  document.addEventListener('DOMContentLoaded', initAvailabilityIndicator);
  document.addEventListener('astro:page-load', initAvailabilityIndicator);
</script>
