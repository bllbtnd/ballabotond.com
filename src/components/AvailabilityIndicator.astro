---
// Availability Indicator Component
// Shows current availability status based on calendar data
import { fetchCalendars, getAvailability } from '../utils/calendar';
import type { Languages } from '../i18n/utils';

interface Props {
  lang: Languages;
  t: (key: string) => string;
}

const { lang, t } = Astro.props;

const calendarUrls = import.meta.env.PUBLIC_CALENDAR_URLS?.split(',').map((url: string) => url.trim()).filter(Boolean) || [];

let isAvailable = false;
let showIndicator = false;

if (calendarUrls.length > 0) {
  try {
    const busySlots = await fetchCalendars(calendarUrls);
    const availability = getAvailability(busySlots, 1); // Only check current week
    
    // Find today's availability
    const now = new Date();
    const today = availability.find(day => {
      return day.date.getDate() === now.getDate() &&
             day.date.getMonth() === now.getMonth() &&
             day.date.getFullYear() === now.getFullYear();
    });
    
    if (today && !today.isPast && today.hourlyAvailability) {
      // Check current hour availability (6 AM to 10 PM range)
      const currentHour = now.getHours();
      if (currentHour >= 6 && currentHour <= 22) {
        const hourIndex = currentHour - 6; // Index 0 = 6 AM
        isAvailable = today.hourlyAvailability[hourIndex] === true;
        showIndicator = true;
      }
    }
  } catch (error) {
    console.error('Failed to fetch availability:', error);
  }
}
---

{showIndicator && (
  <div class="availability-indicator" id="availability-indicator">
    <div class={`status-dot ${isAvailable ? 'available' : 'busy'}`}></div>
    <span class="status-text">
      {isAvailable ? t('home.available') : t('home.busy')}
    </span>
  </div>
)}

<style>
  .availability-indicator {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.375rem 0.75rem;
    background: rgba(255, 255, 255, 0.02);
    backdrop-filter: blur(8px);
    border-radius: 9999px;
    border: 1px solid rgba(198, 162, 88, 0.1);
    font-family: 'Montserrat', sans-serif;
    font-size: 0.6875rem;
    font-weight: 400;
    color: rgba(229, 231, 235, 0.6);
    transition: all 0.3s ease;
    opacity: 0.7;
  }

  .availability-indicator:hover {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(198, 162, 88, 0.2);
    opacity: 1;
    color: rgba(229, 231, 235, 0.85);
  }

  .availability-indicator.scrolled-down {
    opacity: 0;
    pointer-events: none;
  }

  .status-dot {
    width: 0.5rem;
    height: 0.5rem;
    border-radius: 50%;
    position: relative;
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }

  .status-dot.available {
    background-color: #10b981;
    box-shadow: 0 0 6px rgba(16, 185, 129, 0.3);
  }

  .status-dot.busy {
    background-color: #ef4444;
    box-shadow: 0 0 6px rgba(239, 68, 68, 0.3);
  }

  @keyframes pulse {
    0%, 100% {
      opacity: 1;
    }
    50% {
      opacity: 0.7;
    }
  }

  .status-text {
    letter-spacing: 0.08em;
    text-transform: uppercase;
    font-size: 0.625rem;
    font-weight: 300;
  }
</style>

<script>
  let scrollHandler: (() => void) | null = null;

  function initAvailabilityIndicator() {
    const indicator = document.getElementById('availability-indicator');
    if (!(indicator instanceof HTMLElement)) return;

    // Remove old handler if exists
    if (scrollHandler) {
      window.removeEventListener('scroll', scrollHandler);
    }

    let lastScrollY = window.scrollY;
    const handleScroll = () => {
      const currentScrollY = window.scrollY;

      if (currentScrollY > 50) {
        if (currentScrollY > lastScrollY) {
          indicator.classList.add('scrolled-down');
        } else {
          indicator.classList.remove('scrolled-down');
        }
      } else {
        indicator.classList.remove('scrolled-down');
      }

      lastScrollY = currentScrollY;
    };

    scrollHandler = () => {
      requestAnimationFrame(handleScroll);
    };

    // Run once to sync initial state
    handleScroll();

    window.addEventListener('scroll', scrollHandler, { passive: true });
  }

  document.addEventListener('DOMContentLoaded', initAvailabilityIndicator);
  document.addEventListener('astro:page-load', initAvailabilityIndicator);
</script>
