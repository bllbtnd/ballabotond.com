---import { languages, getLangFromUrl } from "../i18n/utils";

const lang = getLangFromUrl(Astro.url);
const currentPath = Astro.url.pathname;

// Remove language prefix to get the base path
let basePath = currentPath;
// Remove the language prefix if it exists (e.g., /hu/resume -> /resume)
basePath = basePath.replace(/^\/[a-z]{2,3}(?=\/|$)/, "") || "/";

// Function to get the correct path for each language
function getLocalizedPath(locale: string) {
  if (locale === "en") {
    return basePath;
  }
  return `/${locale}${basePath}`;
}
---

<div
  class="language-dropdown relative transition-opacity duration-300 ease-out"
>
  <!-- Trigger button -->
  <button
    id="lang-trigger"
    class="flex items-center gap-2 px-3 py-2 text-sm font-montserrat font-medium uppercase tracking-wider text-luxury-gold hover:text-white transition-all duration-300 group"
    aria-label="Select language"
  >
    <span
      class="text-luxury-gold group-hover:text-white transition-colors duration-300"
    >
      {languages[lang]}
    </span>
    <i
      class="fas fa-chevron-down text-xs text-luxury-gold group-hover:text-white transition-all duration-300 transform group-hover:rotate-180"
    ></i>
  </button>

  <!-- Dropdown menu -->
  <div
    id="lang-menu"
    class="absolute top-full mt-1 bg-gray-900 bg-opacity-95 backdrop-blur-md border border-gray-700 rounded-lg shadow-xl overflow-hidden opacity-0 invisible transform translate-y-2 scale-95 transition-all duration-300 z-50 min-w-32"
  >
    {
      Object.entries(languages).map(([locale, name]) => (
        <a
          href={getLocalizedPath(locale)}
          class={`block px-4 py-3 text-sm font-montserrat transition-all duration-200 ${
            locale === lang
              ? "bg-luxury-gold text-gray-900 font-semibold"
              : "text-luxury-gray hover:bg-gray-800 hover:text-luxury-gold"
          }`}
          data-locale={locale}
        >
          <span class="uppercase tracking-wider">{name}</span>
        </a>
      ))
    }
  </div>
</div>

<style>
  .language-dropdown.active #lang-menu {
    opacity: 1;
    visibility: visible;
    transform: translateY(0) scale(1);
  }

  /* Mobile responsive adjustments */
  @media (max-width: 768px) {
    .language-dropdown #lang-menu {
      right: -1rem;
      left: -1rem;
      min-width: auto;
    }
  }
</style>

<script>
  function initLanguageSwitcher() {
    const trigger = document.getElementById("lang-trigger");
    const menu = document.getElementById("lang-menu");
    const dropdown = document.querySelector(
      ".language-dropdown",
    ) as HTMLElement;

    if (!trigger || !menu || !dropdown) return;

    let isOpen = false;

    const positionDropdown = () => {
      const rect = trigger.getBoundingClientRect();
      const menuRect = menu.getBoundingClientRect();
      const viewportWidth = window.innerWidth;

      menu.style.left = "auto";
      menu.style.right = "auto";

      if (rect.right + menuRect.width > viewportWidth) {
        menu.style.right = "0";
      } else {
        menu.style.left = "0";
      }
    };

    const toggleDropdown = () => {
      isOpen = !isOpen;
      if (isOpen) {
        positionDropdown();
        dropdown.classList.add("active");
      } else {
        dropdown.classList.remove("active");
      }
    };

    const closeDropdown = () => {
      isOpen = false;
      dropdown.classList.remove("active");
    };

    // Toggle on button click
    trigger.addEventListener("click", (e) => {
      e.stopPropagation();
      toggleDropdown();
    });

    // Close when clicking outside
    document.addEventListener("click", (e) => {
      if (e.target && !dropdown.contains(e.target as Node)) {
        closeDropdown();
      }
    });

    // Close on escape key
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && isOpen) {
        closeDropdown();
      }
    });

    // Scroll-based opacity
    let lastScrollY = window.scrollY;
    const handleScroll = () => {
      const currentScrollY = window.scrollY;

      if (currentScrollY > 50) {
        if (currentScrollY > lastScrollY) {
          dropdown.style.opacity = "0.7";
        } else {
          dropdown.style.opacity = "1";
        }
      } else {
        dropdown.style.opacity = "1";
      }

      lastScrollY = currentScrollY;
    };

    window.addEventListener(
      "scroll",
      () => {
        requestAnimationFrame(handleScroll);
      },
      { passive: true },
    );
  }

  // Initialize on first load
  document.addEventListener("DOMContentLoaded", initLanguageSwitcher);

  // CRITICAL: Reinitialize after every View Transition (language/page change)
  document.addEventListener("astro:page-load", initLanguageSwitcher);
</script>
